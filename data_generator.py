"""
مولد بيانات مخاطر المكتبات
يولد 50,000 مشكلة مع تصنيفاتها وحلولها
يشمل الفصحى والعامية المصرية
"""

import pandas as pd
import random
from typing import List, Dict, Tuple

# قوالب المشاكل لكل فئة
PROBLEM_TEMPLATES = {
    "بيئية": {
        "templates": [
            # فصحى
            "تسرب مياه الأمطار من {location} مما يؤثر على {item}",
            "ارتفاع درجة الحرارة في {location} يؤثر على {item}",
            "رطوبة عالية في {location} تسبب تلف {item}",
            "تعرض {item} لأشعة الشمس المباشرة في {location}",
            "انتشار الحشرات في {location} يهدد {item}",
            "تراكم الغبار على {item} في {location}",
            "فيضان مياه في {location} أدى لتلف {item}",
            "عاصفة رملية أثرت على {location} و{item}",
            "انقطاع التهوية في {location} يؤثر على {item}",
            "تسرب مياه الصرف بالقرب من {location}",
            "روائح كريهة في {location} بسبب مشاكل بيئية",
            "نمو العفن على {item} في {location}",
            "تلوث الهواء في {location} يؤثر على {item}",
            "برودة شديدة في {location} تؤثر على {item}",
            "زلزال خفيف أثر على {location}",
            "حريق صغير في {location} بسبب ماس كهربائي",
            "دخان كثيف في {location} من مصدر خارجي",
            "تجمع مياه راكدة بالقرب من {location}",
            "انهيار جزئي في سقف {location}",
            "تشققات في جدران {location}",
            # عامية مصرية
            "المطر نزل جوه {location} وبوظ {item}",
            "الحر شديد في {location} و{item} بتتأثر",
            "الرطوبة عالية أوي في {location} و{item} بتبوظ",
            "الشمس بتضرب على {item} في {location} مباشرة",
            "الحشرات ملت {location} وبتأكل {item}",
            "التراب متراكم على {item} في {location}",
            "المية غرقت {location} وبوظت {item}",
            "العاصفة خربت {location} و{item}",
            "التهوية مش شغالة في {location} و{item} بتتأثر",
            "فيه تسريب مجاري جنب {location}",
            "ريحة وحشة في {location} من مشاكل بيئية",
            "العفن طالع على {item} في {location}",
            "الجو ملوث في {location} وبيأثر على {item}",
            "البرد شديد في {location} وبيأثر على {item}",
            "حصل زلزال خفيف وأثر على {location}",
            "حصل حريق صغير في {location} من ماس كهربائي",
            "دخان كتير في {location} جاي من بره",
            "مية راكدة جنب {location}",
            "السقف وقع جزء منه في {location}",
            "الحيطان فيها شروخ في {location}",
            "المكان بايظ من الرطوبة في {location}",
            "الكتب بتعفن من المية في {location}",
            "الحر خلى {item} تبوظ في {location}",
            "مفيش تهوية في {location} والجو خانق",
            "الأرضية مبلولة في {location} من التسريب",
        ],
        "locations": ["قاعة القراءة", "المخزن", "قسم المراجع", "قسم الدوريات", "المكتب الإداري",
                     "قاعة الاطلاع", "قسم الأطفال", "قسم الكتب النادرة", "الطابق الأرضي", "الطابق العلوي",
                     "غرفة الأرشيف", "قاعة المؤتمرات", "مدخل المكتبة", "الممرات", "قسم الإعارة"],
        "items": ["الكتب", "المخطوطات", "الوثائق", "الأجهزة الإلكترونية", "الأثاث", "السجلات",
                 "المجلات", "الخرائط", "الصور", "الأفلام", "الأقراص المدمجة", "المعدات", "الأرفف"],
        "solutions": [
            "تركيب نظام تكييف مركزي",
            "صيانة دورية لنظام التهوية",
            "تركيب أجهزة قياس الرطوبة",
            "عزل النوافذ والأسقف",
            "رش مبيدات حشرية آمنة",
            "تنظيف دوري للمكتبة",
            "تركيب ستائر واقية من الشمس",
            "إصلاح تسربات المياه فوراً",
            "تركيب نظام إنذار للحريق",
            "توفير طفايات حريق",
            "نقل المواد الثمينة لمكان آمن",
            "تركيب مراوح شفط",
            "معالجة الجدران ضد الرطوبة",
        ]
    },
    "مادية/معدات": {
        "templates": [
            # فصحى
            "تلف {equipment} في {location}",
            "عطل في {equipment} يؤثر على العمل",
            "نقص في {equipment} المطلوبة",
            "قدم {equipment} وحاجتها للاستبدال",
            "كسر في {equipment} بسبب سوء الاستخدام",
            "عدم توفر قطع غيار لـ{equipment}",
            "صعوبة صيانة {equipment}",
            "ضعف أداء {equipment}",
            "توقف {equipment} عن العمل فجأة",
            "صدور أصوات غريبة من {equipment}",
            "ارتفاع حرارة {equipment} أثناء التشغيل",
            "تآكل {equipment} بسبب الاستخدام المتكرر",
            "عدم توافق {equipment} مع الأنظمة الحديثة",
            "نفاد عمر {equipment} الافتراضي",
            "تسرب حبر من {equipment}",
            "انسداد في {equipment}",
            "خلل في شاشة {equipment}",
            "بطء شديد في {equipment}",
            "عدم استجابة {equipment} للأوامر",
            "تلف كابلات {equipment}",
            # عامية مصرية
            "{equipment} باظت في {location}",
            "{equipment} عطلانة ومش شغالة",
            "محتاجين {equipment} مش موجودة",
            "{equipment} قديمة ومحتاجة تتغير",
            "{equipment} اتكسرت من سوء الاستخدام",
            "مفيش قطع غيار لـ{equipment}",
            "{equipment} صعب نصلحها",
            "{equipment} شغالة بس بطيئة أوي",
            "{equipment} وقفت فجأة",
            "{equipment} بتطلع صوت غريب",
            "{equipment} بتسخن أوي وهي شغالة",
            "{equipment} اتآكلت من كتر الاستخدام",
            "{equipment} مش متوافقة مع الأجهزة الجديدة",
            "{equipment} خلص عمرها الافتراضي",
            "الحبر بيسرب من {equipment}",
            "{equipment} مسدودة",
            "شاشة {equipment} فيها مشكلة",
            "{equipment} بطيئة جداً",
            "{equipment} مش بترد على الأوامر",
            "الكابلات بتاعة {equipment} باظت",
            "{equipment} محتاجة صيانة ضروري",
            "{equipment} مش شغالة خالص",
            "الكرسي مكسور في {location}",
            "الترابيزة خربانة في {location}",
            "الأرفف وقعت في {location}",
        ],
        "equipment": ["الطابعة", "جهاز الحاسوب", "الماسح الضوئي", "جهاز العرض", "نظام الإضاءة",
                     "المكيف", "الأرفف", "الكراسي", "الطاولات", "خزائن الكتب", "آلة التصوير",
                     "جهاز الباركود", "السيرفر", "الراوتر", "الشاشات", "لوحات المفاتيح", "الفأرة"],
        "locations": ["قاعة القراءة", "المخزن", "قسم المراجع", "المكتب الإداري", "قسم الإعارة",
                     "قاعة الحاسوب", "غرفة السيرفر", "الاستقبال"],
        "solutions": [
            "صيانة دورية للمعدات",
            "استبدال المعدات القديمة",
            "توفير قطع غيار احتياطية",
            "تدريب الموظفين على الاستخدام الصحيح",
            "التعاقد مع شركة صيانة",
            "وضع جدول للصيانة الوقائية",
            "شراء معدات جديدة",
            "تحديث الأجهزة القديمة",
            "توفير ضمان للمعدات",
            "إنشاء سجل لتتبع حالة المعدات",
        ]
    },
    "تشغيلية": {
        "templates": [
            # فصحى
            "تأخر في {process} بسبب {reason}",
            "خطأ في {process} أدى إلى {consequence}",
            "عدم اكتمال {process} في الوقت المحدد",
            "ازدواجية في {process}",
            "غياب إجراءات واضحة لـ{process}",
            "صعوبة في تنفيذ {process}",
            "شكاوى من المستفيدين بخصوص {process}",
            "تراكم العمل في {process}",
            "نقص الكفاءة في {process}",
            "عدم توثيق {process} بشكل صحيح",
            "تعارض بين {process} وإجراءات أخرى",
            "بطء في {process}",
            "أخطاء متكررة في {process}",
            "عدم متابعة {process}",
            "فقدان بيانات أثناء {process}",
            "سوء تنسيق في {process}",
            "عدم وضوح المسؤوليات في {process}",
            "تجاوز الميزانية في {process}",
            "عدم الالتزام بالمواعيد في {process}",
            "نقص الموارد لإتمام {process}",
            # عامية مصرية
            "{process} اتأخرت بسبب {reason}",
            "حصل غلط في {process} وسبب {consequence}",
            "{process} مخلصتش في الوقت",
            "الشغل متكرر في {process}",
            "مفيش خطوات واضحة لـ{process}",
            "{process} صعبة نعملها",
            "الناس بتشتكي من {process}",
            "الشغل متراكم في {process}",
            "{process} مش ماشية كويس",
            "{process} مش متسجلة صح",
            "فيه تعارض في {process}",
            "{process} بطيئة أوي",
            "بيحصل أخطاء كتير في {process}",
            "محدش بيتابع {process}",
            "البيانات ضاعت في {process}",
            "التنسيق وحش في {process}",
            "محدش عارف مسؤول عن إيه في {process}",
            "الميزانية خلصت في {process}",
            "المواعيد مش بتتحقق في {process}",
            "مفيش موارد كفاية لـ{process}",
            "الإعارة بتاخد وقت طويل",
            "الكتب مش مرتبة صح",
            "الفهرسة غلط",
            "الجرد مش مظبوط",
            "الناس مش لاقية الكتب اللي عايزاها",
        ],
        "process": ["عملية الإعارة", "عملية الإرجاع", "فهرسة الكتب", "جرد المقتنيات", "خدمة المستفيدين",
                   "تسجيل الأعضاء", "حجز القاعات", "طلب الكتب", "التزويد", "الفرز", "الترتيب",
                   "إعداد التقارير", "المتابعة اليومية", "إدارة المخزون", "التواصل مع الموردين"],
        "reason": ["نقص الموظفين", "عطل النظام", "كثرة الطلبات", "غياب التنسيق", "عدم وضوح الإجراءات",
                  "نقص التدريب", "ضغط العمل", "مشاكل تقنية", "سوء التخطيط"],
        "consequence": ["تأخر الخدمة", "شكاوى المستفيدين", "فقدان البيانات", "ازدواجية العمل", "هدر الموارد"],
        "solutions": [
            "وضع إجراءات تشغيلية موحدة",
            "تدريب الموظفين على الإجراءات",
            "أتمتة العمليات الروتينية",
            "توزيع المهام بشكل واضح",
            "متابعة دورية للعمليات",
            "إنشاء نظام للشكاوى والمقترحات",
            "تحسين التواصل بين الأقسام",
            "وضع مؤشرات أداء",
            "مراجعة الإجراءات دورياً",
            "توفير موارد كافية",
        ]
    },

    "تقنية": {
        "templates": [
            # فصحى
            "عطل في {system} يمنع {action}",
            "بطء شديد في {system}",
            "توقف {system} عن العمل",
            "فقدان بيانات من {system}",
            "صعوبة الوصول إلى {system}",
            "عدم توافق {system} مع {other_system}",
            "ثغرة أمنية في {system}",
            "انتهاء صلاحية ترخيص {system}",
            "عدم تحديث {system}",
            "مشكلة في الاتصال بـ{system}",
            "خطأ في قاعدة بيانات {system}",
            "تعطل خادم {system}",
            "مشكلة في النسخ الاحتياطي لـ{system}",
            "اختراق محتمل لـ{system}",
            "فيروسات في {system}",
            "عدم استجابة {system}",
            "رسائل خطأ متكررة في {system}",
            "فشل تسجيل الدخول إلى {system}",
            "مشكلة في طباعة التقارير من {system}",
            "عدم مزامنة البيانات في {system}",
            # عامية مصرية
            "{system} عطلان ومش بيخليني أعمل {action}",
            "{system} بطيء جداً",
            "{system} وقف خالص",
            "البيانات ضاعت من {system}",
            "مش قادر أدخل على {system}",
            "{system} مش متوافق مع {other_system}",
            "فيه ثغرة في {system}",
            "الترخيص بتاع {system} خلص",
            "{system} محتاج تحديث",
            "الاتصال بـ{system} فيه مشكلة",
            "قاعدة البيانات بتاعة {system} فيها غلط",
            "السيرفر بتاع {system} واقع",
            "الباك أب بتاع {system} مش شغال",
            "{system} ممكن يكون اتهكر",
            "فيه فيروسات في {system}",
            "{system} مش بيرد",
            "{system} بيطلع رسائل خطأ كتير",
            "مش قادر أسجل دخول في {system}",
            "الطباعة من {system} مش شغالة",
            "البيانات مش بتتزامن في {system}",
            "النت فصل والسيستم وقف",
            "الكمبيوتر هنج",
            "البرنامج بيقفل لوحده",
            "الموقع مش بيفتح",
            "الإيميل مش شغال",
        ],
        "system": ["نظام الفهرسة", "نظام الإعارة", "قاعدة البيانات", "الموقع الإلكتروني", "نظام الأرشفة",
                  "البريد الإلكتروني", "نظام إدارة المكتبة", "الشبكة الداخلية", "نظام الباركود",
                  "نظام الحجز", "نظام التقارير", "نظام العضوية", "السيرفر الرئيسي"],
        "action": ["البحث", "الإعارة", "الإرجاع", "التسجيل", "الطباعة", "الحفظ", "الاستعلام"],
        "other_system": ["النظام الجديد", "الأجهزة الحديثة", "المتصفحات", "أنظمة التشغيل"],
        "solutions": [
            "تحديث الأنظمة بانتظام",
            "عمل نسخ احتياطية يومية",
            "تركيب برامج حماية",
            "تدريب الموظفين على الأنظمة",
            "التعاقد مع دعم فني",
            "ترقية الأجهزة والبرامج",
            "إنشاء خطة للتعافي من الكوارث",
            "مراقبة أداء الأنظمة",
            "تجديد التراخيص في الوقت المناسب",
            "توثيق الإجراءات التقنية",
        ]
    },
    "أمنية": {
        "templates": [
            # فصحى
            "سرقة {item} من {location}",
            "محاولة سرقة {item}",
            "تخريب {item} في {location}",
            "دخول غير مصرح به إلى {location}",
            "فقدان {item} بشكل غامض",
            "تهديد أمني في {location}",
            "شخص مشبوه في {location}",
            "عبث بـ{item}",
            "كتابة على {item}",
            "تمزيق صفحات من {item}",
            "إخفاء {item} في مكان غير مخصص",
            "استخدام غير مصرح لـ{item}",
            "نسخ غير قانوني لـ{item}",
            "إتلاف متعمد لـ{item}",
            "سلوك عدواني في {location}",
            "إزعاج المستفيدين في {location}",
            "تصوير غير مصرح في {location}",
            "انتحال هوية للحصول على {item}",
            "استخدام بطاقة عضوية مزورة",
            "محاولة إخراج {item} بدون إعارة",
            # عامية مصرية
            "حد سرق {item} من {location}",
            "حد حاول يسرق {item}",
            "حد خرب {item} في {location}",
            "حد دخل {location} من غير إذن",
            "{item} ضاعت ومش عارفين إزاي",
            "فيه تهديد أمني في {location}",
            "فيه حد مشبوه في {location}",
            "حد عبث بـ{item}",
            "حد كتب على {item}",
            "حد قطع صفحات من {item}",
            "حد خبى {item} في مكان تاني",
            "حد استخدم {item} من غير إذن",
            "حد نسخ {item} بطريقة غير قانونية",
            "حد بوظ {item} عمداً",
            "فيه حد بيتصرف بعدوانية في {location}",
            "فيه حد بيزعج الناس في {location}",
            "حد بيصور في {location} من غير إذن",
            "حد انتحل شخصية عشان ياخد {item}",
            "حد استخدم كارنيه مزور",
            "حد حاول يطلع {item} من غير إعارة",
            "الكتب بتتسرق كتير",
            "فيه ناس بتخرب في المكتبة",
            "الأمن ضعيف في {location}",
            "الكاميرات مش شغالة",
            "البوابات الإلكترونية عطلانة",
        ],
        "item": ["الكتب", "المخطوطات", "الأجهزة", "المعدات", "الوثائق", "المجلات النادرة",
                "الخرائط القديمة", "الصور التاريخية", "الأقراص المدمجة", "اللوحات"],
        "location": ["قاعة القراءة", "المخزن", "قسم المراجع", "قسم الكتب النادرة", "المدخل",
                    "قسم الأطفال", "قاعة الحاسوب", "الأرشيف"],
        "solutions": [
            "تركيب كاميرات مراقبة",
            "توظيف حراس أمن",
            "تركيب بوابات إلكترونية",
            "وضع شرائح أمان على الكتب",
            "تسجيل الزوار",
            "تحديد صلاحيات الدخول",
            "تدريب الموظفين على الإجراءات الأمنية",
            "وضع لوائح واضحة للمستفيدين",
            "تركيب أجهزة إنذار",
            "التنسيق مع الجهات الأمنية",
        ]
    },
    "إدارية": {
        "templates": [
            # فصحى
            "نقص في {resource} يؤثر على {area}",
            "غياب {staff} يؤثر على {area}",
            "تأخر في {decision} بخصوص {area}",
            "عدم وضوح {policy} المتعلقة بـ{area}",
            "تعارض بين {department} و{other_department}",
            "ضعف التواصل بين {department} و{other_department}",
            "عدم توفر ميزانية لـ{area}",
            "تأخر صرف {resource}",
            "غياب خطة لـ{area}",
            "عدم متابعة {area}",
            "شكاوى من {staff} بخصوص {area}",
            "دوران وظيفي عالي في {department}",
            "نقص التدريب في {area}",
            "عدم تحديث {policy}",
            "بيروقراطية في {area}",
            "تأخر الترقيات في {department}",
            "عدم وجود حوافز في {department}",
            "ضعف الرقابة على {area}",
            "غياب التقييم الدوري لـ{area}",
            "عدم توثيق {policy}",
            # عامية مصرية
            "فيه نقص في {resource} وبيأثر على {area}",
            "{staff} غايب وده بيأثر على {area}",
            "{decision} اتأخر بخصوص {area}",
            "{policy} مش واضحة في {area}",
            "فيه خناقة بين {department} و{other_department}",
            "التواصل ضعيف بين {department} و{other_department}",
            "مفيش ميزانية لـ{area}",
            "{resource} اتأخر صرفها",
            "مفيش خطة لـ{area}",
            "محدش بيتابع {area}",
            "{staff} بيشتكوا من {area}",
            "الموظفين بيمشوا كتير من {department}",
            "مفيش تدريب في {area}",
            "{policy} محتاجة تتحدث",
            "الروتين كتير في {area}",
            "الترقيات متأخرة في {department}",
            "مفيش حوافز في {department}",
            "الرقابة ضعيفة على {area}",
            "مفيش تقييم دوري لـ{area}",
            "{policy} مش موثقة",
            "الإدارة مش بتسمع للموظفين",
            "القرارات بتتاخد ببطء",
            "مفيش تنسيق بين الأقسام",
            "الموظفين مش متدربين كويس",
            "المرتبات قليلة",
            "ساعات العمل طويلة",
            "مفيش إجازات كفاية",
            "الشغل كتير والموظفين قليلين",
        ],
        "resource": ["الميزانية", "الموظفين", "المعدات", "المواد", "التدريب"],
        "staff": ["الموظفين", "المدير", "المشرف", "أمين المكتبة", "الفني"],
        "decision": ["القرار", "الموافقة", "التخطيط", "التنفيذ"],
        "policy": ["السياسة", "اللائحة", "الإجراء", "القانون", "النظام"],
        "area": ["خدمة المستفيدين", "الإعارة", "التزويد", "الفهرسة", "الصيانة", "التطوير"],
        "department": ["قسم الإعارة", "قسم الفهرسة", "قسم التزويد", "الإدارة", "قسم الخدمات"],
        "other_department": ["الإدارة العليا", "المالية", "الموارد البشرية", "تقنية المعلومات"],
        "solutions": [
            "وضع خطة استراتيجية",
            "تحسين التواصل الداخلي",
            "توفير ميزانية كافية",
            "تدريب وتطوير الموظفين",
            "وضع سياسات واضحة",
            "تفويض الصلاحيات",
            "عقد اجتماعات دورية",
            "إنشاء نظام للحوافز",
            "تقييم الأداء بانتظام",
            "توثيق الإجراءات الإدارية",
        ]
    }
}


class LibraryRiskDataGenerator:
    """مولد بيانات مخاطر المكتبات"""
    
    def __init__(self, num_samples: int=50000):
        self.num_samples = num_samples
        self.categories = list(PROBLEM_TEMPLATES.keys())
        
    def _generate_problem(self, category: str, idx: int=0) -> Tuple[str, str]:
        """توليد مشكلة واحدة مع حلولها"""
        cat_data = PROBLEM_TEMPLATES[category]
        template = random.choice(cat_data["templates"])
        
        # إضافات للتنوع
        prefixes = ["", "مشكلة: ", "بلاغ: ", "شكوى: ", "ملاحظة: ", "تنبيه: ", "عاجل: "]
        suffixes = ["", " - يحتاج متابعة", " - عاجل", " - للمراجعة", " - مهم"]
        
        # استبدال المتغيرات في القالب
        problem = template
        for key in ["location", "locations", "item", "items", "equipment", "process",
                    "reason", "consequence", "system", "action", "other_system",
                    "resource", "staff", "decision", "policy", "area", "department", "other_department"]:
            if "{" + key + "}" in problem:
                if key in cat_data:
                    problem = problem.replace("{" + key + "}", random.choice(cat_data[key]))
                elif key + "s" in cat_data:
                    problem = problem.replace("{" + key + "}", random.choice(cat_data[key + "s"]))
        
        # إضافة تنوع برقم البلاغ أو بادئة/لاحقة
        if idx % 5 == 0:
            problem = f"{random.choice(prefixes)}{problem}"
        elif idx % 5 == 1:
            problem = f"{problem}{random.choice(suffixes)}"
        elif idx % 5 == 2:
            problem = f"{problem} (بلاغ رقم {idx})"
        elif idx % 5 == 3:
            problem = f"[{category}] {problem}"
        
        # اختيار 2-4 حلول عشوائية
        num_solutions = random.randint(2, 4)
        solutions = random.sample(cat_data["solutions"], min(num_solutions, len(cat_data["solutions"])))
        solutions_str = "، ".join(solutions)
        
        return problem, solutions_str
    
    def generate_problems(self) -> pd.DataFrame:
        """توليد جميع المشاكل"""
        data = []
        samples_per_category = self.num_samples // len(self.categories)
        extra = self.num_samples % len(self.categories)
        idx = 0
        
        for i, category in enumerate(self.categories):
            # توزيع العينات الإضافية على الفئات الأولى
            n = samples_per_category + (1 if i < extra else 0)
            
            for _ in range(n):
                problem, solutions = self._generate_problem(category, idx)
                idx += 1
                data.append({
                    "مشكلة": problem,
                    "فئة المخاطر": category,
                    "الحلول": solutions
                })
        
        # خلط البيانات
        random.shuffle(data)
        return pd.DataFrame(data)
    
    def save_to_csv(self, df: pd.DataFrame, filepath: str="risk_data.csv") -> None:
        """حفظ البيانات في ملف CSV"""
        df.to_csv(filepath, index=False, encoding="utf-8-sig")
        print(f"تم حفظ {len(df)} مشكلة في {filepath}")


if __name__ == "__main__":
    print("بدء توليد 50,000 مشكلة...")
    generator = LibraryRiskDataGenerator(num_samples=50000)
    df = generator.generate_problems()
    generator.save_to_csv(df)
    
    # عرض إحصائيات
    print("\nإحصائيات البيانات:")
    print(df["فئة المخاطر"].value_counts())
    print(f"\nإجمالي المشاكل: {len(df)}")
    print(f"عدد المشاكل الفريدة: {df['مشكلة'].nunique()}")
